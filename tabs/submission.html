<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Submission Mobility</title>
<style>
body { font-family: Arial; margin:8px; font-size:12px; }
.form-section { border:1px solid #ccc; padding:4px; margin-bottom:6px; border-radius:4px; }
.flex-row { display:flex; gap:6px; flex-wrap:wrap; }
.column { flex:1; min-width:240px; }
.row { display:flex; align-items:center; margin-bottom:3px; gap:4px; }
label { width:95px; font-size:11px; flex-shrink:0; }
input, select, textarea { flex:1; padding:2px 3px; font-size:11px; height:22px; box-sizing:border-box; }
textarea { height:50px; resize:none; }
button { padding:3px 6px; margin:0; font-size:11px; cursor:pointer; }
table { width:100%; border-collapse:collapse; margin-top:5px; font-size:11px; }
th, td { border:1px solid #ccc; padding:2px 4px; text-align:left; }
.planBlock { border:1px solid #aaa; padding:6px; margin-bottom:6px; border-radius:4px; }
.planRow { display:flex; gap:8px; margin-top:4px; align-items:flex-start; flex-wrap:nowrap; }
.planRow .col { display:flex; flex-direction:column; }
.msisdn-sim-section { display:flex; flex-direction:column; gap:1px; }
.msisdn-sim-row { display:flex; align-items:center; gap:3px; }
.msisdnInput { width:16ch; padding:2px 3px; font-size:11px; height:17px; }
.simInput { width:24ch; padding:2px 3px; font-size:11px; height:17px; }
.msisdn-sim-row .action { display:flex; gap:4px; }
.tickbox-group { display:flex; gap:12px; flex-wrap:wrap; margin-top:4px; }
</style>
</head>
<body>

<h3>Submission Mobility</h3>

<div class="form-section">
  <div class="row">
    <label>Send From:</label>
    <select id="sendFrom">
      <option value="">Select Email</option>
    </select>
  </div>
</div>

<div class="form-section flex-row">
  <div class="column">
    <div class="row">
      <label>New/Existing:</label>
      <select id="accountType" onchange="toggleAccountFields()">
        <option value="new" selected>New</option>
        <option value="existing">Existing</option>
      </select>
    </div>
    <div class="row"><label>Account Name:</label><input type="text" id="accountName"></div>
    <div id="existingFields" class="row" style="display:none;">
      <label>Account Number:</label><input type="text" id="accountNumber">
    </div>
  </div>
</div>

<div class="form-section">
  <h4>Plans</h4>
  <div style="margin-bottom:6px;">
    <button onclick="addNewPlan()">Add New Plan</button>
  </div>
  <div id="planContainer"></div>
</div>

<div class="form-section">
  <div>
    <label>Send Submission To:</label>
    <div id="tickSubmission" class="tickbox-group"></div>
  </div>
</div>

<div class="form-section">
  <textarea id="commentBox" placeholder="Add comments here"></textarea>
</div>

<div class="form-section">
  <button onclick="previewTable()">Preview Table</button>
  <div id="preview" style="margin-top:8px;"></div>
  <div style="margin-top:6px;">
    <button onclick="submitEmail()">Submit</button>
  </div>
</div>

<script>
/* Conditional fields */
function toggleAccountFields(){
  const type = document.getElementById('accountType').value;
  document.getElementById('existingFields').style.display = (type === 'existing') ? 'flex' : 'none';
}

/* Plans */
let planCount = 0;
function addNewPlan(){
  planCount++;
  const container = document.getElementById('planContainer');
  const div = document.createElement('div');
  div.className = 'planBlock';
  div.id = 'plan' + planCount;
  div.innerHTML = `
    <div class="planRow">
      <div class="col"><label>Plan</label><input type="text" class="planInput" placeholder="Plan"></div>
      <div class="col"><label>Addons</label><input type="text" class="addonInput" placeholder="Addons"></div>
      <div class="col"><label>Promo</label><input type="text" class="promoInput" placeholder="Promo"></div>
      <div class="col"><label>Discount</label>
        <select class="discountInput">
          <option>No discount</option><option>5%</option><option>10%</option><option>15%</option>
        </select>
      </div>
    </div>
    <div class="msisdn-sim-section" id="ms-section-${planCount}"></div>
  `;
  container.appendChild(div);
  addMSISDNSIMRow(planCount);
}

function addMSISDNSIMRow(planId, msisdnVal = '', simVal = ''){
  const planBlock = document.getElementById('plan' + planId);
  if(!planBlock) return;
  const section = planBlock.querySelector('.msisdn-sim-section');
  const rowDiv = document.createElement('div'); 
  rowDiv.className='msisdn-sim-row';
  rowDiv.innerHTML = `
    <input type="text" class="msisdnInput" placeholder="MSISDN" value="${msisdnVal}">
    <input type="text" class="simInput" placeholder="SIM Serial" value="${simVal}">
    <button class="add-row">+</button>
    <button class="del-row">-</button>
  `;
  section.appendChild(rowDiv);
  rowDiv.querySelector('.add-row').addEventListener('click', ()=>addMSISDNSIMRow(planId));
  rowDiv.querySelector('.del-row').addEventListener('click', ()=>rowDiv.remove());
}

/* Load Outlook emails via preload.js */
async function loadSendFrom(){
  if(window.electronAPI && window.electronAPI.getOutlookEmails){
    const emails = await window.electronAPI.getOutlookEmails();
    const select = document.getElementById('sendFrom');
    emails.forEach(e=>{ 
      const opt = document.createElement('option');
      opt.value = e;
      opt.textContent = e;
      select.appendChild(opt);
    });
  }
}

/* Preview */
function previewTable(){
  const A = document.getElementById('accountName').value||'';
  const plans=[]; 
  document.querySelectorAll('.planBlock').forEach(pr=>{
    const plan = pr.querySelector('.planInput').value||'';
    const addon = pr.querySelector('.addonInput').value||'';
    plans.push({plan, addon});
  });
  let table = `<table><tr><th>Account</th><th>Plan</th><th>Addon</th></tr>`;
  plans.forEach(p=>{
    table += `<tr><td>${A}</td><td>${p.plan}</td><td>${p.addon}</td></tr>`;
  });
  table += `</table>`;
  document.getElementById('preview').innerHTML = table;
}

/* Submit */
function submitEmail(){
  const fromEmail = document.getElementById('sendFrom').value;
  const tableHTML = document.getElementById('preview').innerHTML;
  window.electronAPI.sendEmail({from: fromEmail, to: [], cc: [], html: tableHTML});
}

/* Init */
document.addEventListener('DOMContentLoaded', ()=>{
  addNewPlan();
  toggleAccountFields();
  loadSendFrom();
});
</script>
</body>
</html>
