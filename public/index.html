<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>DSQ Outlook Taskpane - Attach Same Email</title>
<script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 10px; font-size: 13px; }
  label { display:block; margin-top:8px; }
  input, select, textarea, button { margin-top:6px; padding:6px; width:100%; box-sizing:border-box; }
  .row { display:flex; gap:8px; }
  table { width:100%; border-collapse: collapse; margin-top:12px; }
  table, th, td { border:1px solid #999; }
  th, td { padding:6px; text-align:left; font-size:12px; }
</style>
</head>
<body>

<h3>DSQ Request Form</h3>

<label>Account Number</label>
<input type="text" id="accountNumber" placeholder="Enter account number">

<label>Account Name</label>
<input type="text" id="accountName" placeholder="Enter account name">

<label>Msisdns (comma separated)</label>
<input type="text" id="msisdns" placeholder="Enter MSISDNs">

<label>Modification Type</label>
<select id="modType">
  <option value="">--Select--</option>
  <option value="S.L">S.L</option>
  <option value="Plan change">Plan change</option>
  <option value="Addon">Addon</option>
  <option value="Sim swap">Sim swap</option>
  <option value="TON">TON</option>
</select>

<div id="dynamicInputContainer"></div>

<label>Comments</label>
<textarea id="comments" rows="3" placeholder="Enter comments"></textarea>

<div class="row">
  <button id="generateBtn">Generate Table</button>
  <button id="emailAttachBtn">Email & Attach Current Email</button>
</div>

<table id="outputTable" aria-label="Generated table">
  <thead>
    <tr>
      <th style="background-color: yellow; font-weight:bold;">Account number/Sample #</th>
      <th style="background-color: yellow; font-weight:bold;">Account name</th>
      <th style="background-color: yellow; font-weight:bold;">Msisdn(s)</th>
      <th style="background-color: yellow; font-weight:bold;">Sim serial(s)</th>
      <th style="background-color: yellow; font-weight:bold;">S.L</th>
      <th style="background-color: yellow; font-weight:bold;">Modification</th>
      <th style="background-color: yellow; font-weight:bold;">Extras/Addons</th>
      <th style="background-color: yellow; font-weight:bold;">Request Type</th>
      <th style="background-color: yellow; font-weight:bold;">Comments</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>---</td><td>---</td><td>---</td><td>---</td><td>---</td>
      <td>---</td><td>---</td><td>---</td><td>---</td>
    </tr>
  </tbody>
</table>

<script>
Office.onReady(() => {
  const modType = document.getElementById('modType');
  const dynamicContainer = document.getElementById('dynamicInputContainer');
  let extraInput = null;

  modType.addEventListener('change', () => {
    dynamicContainer.innerHTML = '';
    extraInput = null;
    const val = modType.value;
    if (val) {
      const label = document.createElement('label');
      label.textContent = val + ':';
      const input = document.createElement('input');
      input.type = 'text';
      input.id = 'extraField';
      input.placeholder = 'Enter ' + val;
      dynamicContainer.appendChild(label);
      dynamicContainer.appendChild(input);
      extraInput = input;
    }
  });

  function getFormData() {
    const accountNumber = document.getElementById('accountNumber').value.trim() || '---';
    const accountName = document.getElementById('accountName').value.trim() || '---';
    const msisdns = document.getElementById('msisdns').value.trim() || '---';
    const comments = document.getElementById('comments').value.trim() || '---';
    const modSelection = modType.value || '---';
    const extraVal = extraInput ? extraInput.value.trim() || '---' : '---';

    const simSerial = modSelection === 'Sim swap' ? extraVal : '---';
    const slVal = modSelection === 'S.L' ? extraVal : '---';
    const planChange = modSelection === 'Plan change' ? extraVal : '---';
    const addonVal = modSelection === 'Addon' ? extraVal : '---';
    const tonVal = modSelection === 'TON' ? extraVal : '---';

    return { accountNumber, accountName, msisdns, comments, modSelection, simSerial, slVal, planChange, addonVal, tonVal };
  }

  function renderTaskpaneTable(data) {
    const tbody = document.querySelector('#outputTable tbody');
    tbody.innerHTML = `
      <tr>
        <td>${data.accountNumber}</td>
        <td>${data.accountName}</td>
        <td>${data.msisdns}</td>
        <td>${data.simSerial}</td>
        <td>${data.slVal}</td>
        <td>${data.planChange}</td>
        <td>${data.addonVal}</td>
        <td>${data.modSelection}</td>
        <td>${data.comments}</td>
      </tr>
    `;
  }

  function generateTableHtml(data) {
    // Inline styles so Outlook respects them in the composed message.
    return `
      <table style="width:100%; border-collapse: collapse; border:1px solid #999;">
        <thead>
          <tr>
            <th style="border:1px solid #999; background-color: yellow; font-weight:bold; padding:6px;">Account number/Sample #</th>
            <th style="border:1px solid #999; background-color: yellow; font-weight:bold; padding:6px;">Account name</th>
            <th style="border:1px solid #999; background-color: yellow; font-weight:bold; padding:6px;">Msisdn(s)</th>
            <th style="border:1px solid #999; background-color: yellow; font-weight:bold; padding:6px;">Sim serial(s)</th>
            <th style="border:1px solid #999; background-color: yellow; font-weight:bold; padding:6px;">S.L</th>
            <th style="border:1px solid #999; background-color: yellow; font-weight:bold; padding:6px;">Modification</th>
            <th style="border:1px solid #999; background-color: yellow; font-weight:bold; padding:6px;">Extras/Addons</th>
            <th style="border:1px solid #999; background-color: yellow; font-weight:bold; padding:6px;">Request Type</th>
            <th style="border:1px solid #999; background-color: yellow; font-weight:bold; padding:6px;">Comments</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="border:1px solid #999; padding:6px;">${data.accountNumber}</td>
            <td style="border:1px solid #999; padding:6px;">${data.accountName}</td>
            <td style="border:1px solid #999; padding:6px;">${data.msisdns}</td>
            <td style="border:1px solid #999; padding:6px;">${data.simSerial}</td>
            <td style="border:1px solid #999; padding:6px;">${data.slVal}</td>
            <td style="border:1px solid #999; padding:6px;">${data.planChange}</td>
            <td style="border:1px solid #999; padding:6px;">${data.addonVal}</td>
            <td style="border:1px solid #999; padding:6px;">${data.modSelection}</td>
            <td style="border:1px solid #999; padding:6px;">${data.comments}</td>
          </tr>
        </tbody>
      </table>
    `;
  }

  document.getElementById('generateBtn').addEventListener('click', () => {
    renderTaskpaneTable(getFormData());
  });

  // PRIMARY ACTION: Attempt to open ONE new email that includes the table AND attaches the current viewed email as a .msg
  document.getElementById('emailAttachBtn').addEventListener('click', () => {
    const data = getFormData();
    const tableHtml = generateTableHtml(data);
    const bodyHtml = `<p>Hi team,</p><p>Please action the below:</p><p>${escapeHtml(data.comments)}</p>${tableHtml}`;

    // If there is a current item (we're in read mode), attempt to get its itemId to attach as an Item attachment
    const item = Office.context.mailbox.item;
    if (item && item.itemType === Office.MailboxEnums.ItemType.Message && item.getItemIdAsync) {
      // Try to get the itemId
      Office.context.mailbox.item.getItemIdAsync((res) => {
        try {
          if (res.status === Office.AsyncResultStatus.Succeeded && res.value) {
            const itemId = res.value;
            // Attempt to open new message with attachment
            Office.context.mailbox.displayNewMessageForm({
              toRecipients: ['qv@covalenseglobal.com'],
              subject: 'DSQ Request',
              htmlBody: bodyHtml,
              attachments: [{
                type: Office.MailboxEnums.AttachmentType.Item, // use enums for readability
                itemId: itemId,
                name: 'CurrentEmail.msg'
              }]
            });
            return;
          } else {
            // Failed to retrieve itemId — fallback below
            console.warn('getItemIdAsync failed or returned empty:', res.error || res);
            fallbackForwardWithNotice(bodyHtml);
          }
        } catch (e) {
          console.error('Exception while attaching item:', e);
          fallbackForwardWithNotice(bodyHtml);
        }
      });
    } else {
      // No current item available (not read-mode) — just create new message with table
      Office.context.mailbox.displayNewMessageForm({
        toRecipients: ['qv@covalenseglobal.com'],
        subject: 'DSQ Request',
        htmlBody: bodyHtml
      });
    }
  });

  // Fallback: forward the current email and insert the table into the forward body
  function fallbackForwardWithNotice(bodyHtml) {
    try {
      // notify user that direct .msg attach failed and we will forward instead
      alert('Could not attach the current email as a .msg file. Falling back to forward — the original message will be included in the single email.');
      const item = Office.context.mailbox.item;
      if (item && item.forwardAsync) {
        // Use forwardAsync to create a new email that contains the original message (forwarded)
        item.forwardAsync(
          { 
            toRecipients: ['qv@covalenseglobal.com'],
            // include the table + a note at top; forwardAsync will include the original message inline in the forward
            htmlBody: `<p>Hi team,</p><p>Please action the below:</p>${bodyHtml}`
          },
          (result) => {
            if (result.status !== Office.AsyncResultStatus.Succeeded) {
              alert('Fallback forward failed. Opening a new blank email with the table (without attached original message).');
              // last-resort: open a new blank message with the table only
              Office.context.mailbox.displayNewMessageForm({
                toRecipients: ['qv@covalenseglobal.com'],
                subject: 'DSQ Request',
                htmlBody: bodyHtml
              });
            }
          }
        );
      } else {
        // Can't forward (API missing) — open a new message without attachment
        alert('Could not forward the current email. Opening a new email without attachment.');
        Office.context.mailbox.displayNewMessageForm({
          toRecipients: ['qv@covalenseglobal.com'],
          subject: 'DSQ Request',
          htmlBody: bodyHtml
        });
      }
    } catch (err) {
      console.error('fallbackForwardWithNotice exception', err);
      alert('An unexpected error occurred. Opening a new email without attachment.');
      Office.context.mailbox.displayNewMessageForm({
        toRecipients: ['qv@covalenseglobal.com'],
        subject: 'DSQ Request',
        htmlBody: bodyHtml
      });
    }
  }

  // small helper to escape comments when inserting into body as text (we still use the tableHtml separately)
  function escapeHtml(text) {
    if (!text) return '';
    return text
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

});
</script>

</body>
</html>
